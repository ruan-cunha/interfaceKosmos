{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.setRevalidateHeaders = setRevalidateHeaders;\nexports.sendPayload = sendPayload;\nexports.sendRenderResult = sendRenderResult;\nexports.sendEtagResponse = sendEtagResponse;\n\nvar _utils = require(\"../shared/lib/utils\");\n\nvar _etag = _interopRequireDefault(require(\"etag\"));\n\nvar _fresh = _interopRequireDefault(require(\"next/dist/compiled/fresh\"));\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction setRevalidateHeaders(res, options) {\n  if (options.private || options.stateful) {\n    if (options.private || !res.hasHeader('Cache-Control')) {\n      res.setHeader('Cache-Control', `private, no-cache, no-store, max-age=0, must-revalidate`);\n    }\n  } else if (typeof options.revalidate === 'number') {\n    if (options.revalidate < 1) {\n      throw new Error(`invariant: invalid Cache-Control duration provided: ${options.revalidate} < 1`);\n    }\n\n    res.setHeader('Cache-Control', `s-maxage=${options.revalidate}, stale-while-revalidate`);\n  } else if (options.revalidate === false) {\n    res.setHeader('Cache-Control', `s-maxage=31536000, stale-while-revalidate`);\n  }\n}\n\nfunction sendPayload(req, res, payload, type, {\n  generateEtags,\n  poweredByHeader\n}, options) {\n  sendRenderResult({\n    req,\n    res,\n    resultOrPayload: payload,\n    type,\n    generateEtags,\n    poweredByHeader,\n    options\n  });\n}\n\nasync function sendRenderResult({\n  req,\n  res,\n  resultOrPayload,\n  type,\n  generateEtags,\n  poweredByHeader,\n  options\n}) {\n  if ((0, _utils).isResSent(res)) {\n    return;\n  }\n\n  if (poweredByHeader && type === 'html') {\n    res.setHeader('X-Powered-By', 'Next.js');\n  }\n\n  const isPayload = typeof resultOrPayload === 'string';\n\n  if (isPayload) {\n    const etag = generateEtags ? (0, _etag).default(resultOrPayload) : undefined;\n\n    if (sendEtagResponse(req, res, etag)) {\n      return;\n    }\n  }\n\n  if (!res.getHeader('Content-Type')) {\n    res.setHeader('Content-Type', type === 'json' ? 'application/json' : 'text/html; charset=utf-8');\n  }\n\n  if (isPayload) {\n    res.setHeader('Content-Length', Buffer.byteLength(resultOrPayload));\n  }\n\n  if (options != null) {\n    setRevalidateHeaders(res, options);\n  }\n\n  if (req.method === 'HEAD') {\n    res.end(null);\n  } else if (isPayload) {\n    res.end(resultOrPayload);\n  } else {\n    const maybeFlush = typeof res.flush === 'function' ? () => res.flush() : () => {};\n    await resultOrPayload.forEach(chunk => {\n      res.write(chunk);\n      maybeFlush();\n    });\n    res.end();\n  }\n}\n\nfunction sendEtagResponse(req, res, etag) {\n  if (etag) {\n    /**\n    * The server generating a 304 response MUST generate any of the\n    * following header fields that would have been sent in a 200 (OK)\n    * response to the same request: Cache-Control, Content-Location, Date,\n    * ETag, Expires, and Vary. https://tools.ietf.org/html/rfc7232#section-4.1\n    */\n    res.setHeader('ETag', etag);\n  }\n\n  if ((0, _fresh).default(req.headers, {\n    etag\n  })) {\n    res.statusCode = 304;\n    res.end();\n    return true;\n  }\n\n  return false;\n}","map":{"version":3,"sources":["../../server/send-payload.ts"],"names":[],"mappings":"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","sourcesContent":["import { IncomingMessage, ServerResponse } from 'http'\nimport { isResSent } from '../shared/lib/utils'\nimport generateETag from 'etag'\nimport fresh from 'next/dist/compiled/fresh'\nimport { RenderResult } from './utils'\n\nexport type PayloadOptions =\n  | { private: true }\n  | { private: boolean; stateful: true }\n  | { private: boolean; stateful: false; revalidate: number | false }\n\nexport function setRevalidateHeaders(\n  res: ServerResponse,\n  options: PayloadOptions\n) {\n  if (options.private || options.stateful) {\n    if (options.private || !res.hasHeader('Cache-Control')) {\n      res.setHeader(\n        'Cache-Control',\n        `private, no-cache, no-store, max-age=0, must-revalidate`\n      )\n    }\n  } else if (typeof options.revalidate === 'number') {\n    if (options.revalidate < 1) {\n      throw new Error(\n        `invariant: invalid Cache-Control duration provided: ${options.revalidate} < 1`\n      )\n    }\n\n    res.setHeader(\n      'Cache-Control',\n      `s-maxage=${options.revalidate}, stale-while-revalidate`\n    )\n  } else if (options.revalidate === false) {\n    res.setHeader('Cache-Control', `s-maxage=31536000, stale-while-revalidate`)\n  }\n}\n\nexport function sendPayload(\n  req: IncomingMessage,\n  res: ServerResponse,\n  payload: any,\n  type: 'html' | 'json',\n  {\n    generateEtags,\n    poweredByHeader,\n  }: { generateEtags: boolean; poweredByHeader: boolean },\n  options?: PayloadOptions\n): void {\n  sendRenderResult({\n    req,\n    res,\n    resultOrPayload: payload,\n    type,\n    generateEtags,\n    poweredByHeader,\n    options,\n  })\n}\n\nexport async function sendRenderResult({\n  req,\n  res,\n  resultOrPayload,\n  type,\n  generateEtags,\n  poweredByHeader,\n  options,\n}: {\n  req: IncomingMessage\n  res: ServerResponse\n  resultOrPayload: RenderResult | string\n  type: 'html' | 'json'\n  generateEtags: boolean\n  poweredByHeader: boolean\n  options?: PayloadOptions\n}): Promise<void> {\n  if (isResSent(res)) {\n    return\n  }\n\n  if (poweredByHeader && type === 'html') {\n    res.setHeader('X-Powered-By', 'Next.js')\n  }\n\n  const isPayload = typeof resultOrPayload === 'string'\n\n  if (isPayload) {\n    const etag = generateEtags\n      ? generateETag(resultOrPayload as string)\n      : undefined\n    if (sendEtagResponse(req, res, etag)) {\n      return\n    }\n  }\n\n  if (!res.getHeader('Content-Type')) {\n    res.setHeader(\n      'Content-Type',\n      type === 'json' ? 'application/json' : 'text/html; charset=utf-8'\n    )\n  }\n\n  if (isPayload) {\n    res.setHeader(\n      'Content-Length',\n      Buffer.byteLength(resultOrPayload as string)\n    )\n  }\n\n  if (options != null) {\n    setRevalidateHeaders(res, options)\n  }\n\n  if (req.method === 'HEAD') {\n    res.end(null)\n  } else if (isPayload) {\n    res.end(resultOrPayload as string)\n  } else {\n    const maybeFlush =\n      typeof (res as any).flush === 'function'\n        ? () => (res as any).flush()\n        : () => {}\n    await (resultOrPayload as RenderResult).forEach((chunk) => {\n      res.write(chunk)\n      maybeFlush()\n    })\n    res.end()\n  }\n}\n\nexport function sendEtagResponse(\n  req: IncomingMessage,\n  res: ServerResponse,\n  etag: string | undefined\n): boolean {\n  if (etag) {\n    /**\n     * The server generating a 304 response MUST generate any of the\n     * following header fields that would have been sent in a 200 (OK)\n     * response to the same request: Cache-Control, Content-Location, Date,\n     * ETag, Expires, and Vary. https://tools.ietf.org/html/rfc7232#section-4.1\n     */\n    res.setHeader('ETag', etag)\n  }\n\n  if (fresh(req.headers, { etag })) {\n    res.statusCode = 304\n    res.end()\n    return true\n  }\n\n  return false\n}\n"]},"metadata":{},"sourceType":"script"}